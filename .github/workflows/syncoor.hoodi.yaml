name: Syncoor - Hoodi
on:
  workflow_dispatch:
  #schedule:
  #  - cron: "45 05 * * 5" # Every Friday at 05:45 UTC

env:
  NETWORK: "hoodi"
  EL_IMAGES: >-
    {
      "besu": "hyperledger/besu:25.9.0",
      "geth": "ethereum/client-go:v1.16.4",
      "erigon": "erigontech/erigon:v3.2.0-rc1",
      "nethermind": "nethermind/nethermind:1.34.0",
      "reth": "ghcr.io/paradigmxyz/reth:v1.8.2",
      "nimbusel": "ethpandaops/nimbus-eth1:master"
    }
  CL_IMAGES: >-
    {
      "lighthouse": "sigp/lighthouse:v8.0.0-rc.0",
      "teku": "consensys/teku:25.9.3",
      "prysm": "gcr.io/offchainlabs/prysm/beacon-chain:v6.1.1",
      "nimbus": "statusim/nimbus-eth2:multiarch-v25.9.2",
      "lodestar": "chainsafe/lodestar:v1.35.0-rc.1",
      "grandine": "sifrai/grandine:2.0.0.rc0"
    }

jobs:
  trigger-syncoor:
    runs-on: ubuntu-latest
    steps:
      - name: Check for running workflows with same network
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        id: check-running
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: >-
            const { data: workflows } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'syncoor.yaml',
              status: 'in_progress',
              per_page: 100
            });

            const { data: queuedWorkflows } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'syncoor.yaml',
              status: 'queued',
              per_page: 100
            });

            const allWorkflows = [...workflows.workflow_runs, ...queuedWorkflows.workflow_runs];

            const network = "${{ env.NETWORK }}";
            let runningWorkflows = [];

            // Check each workflow run's jobs to see if any contain the network name
            for (const run of allWorkflows) {
              try {
                const { data: jobs } = await github.rest.actions.listJobsForWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  run_id: run.id
                });

                const hasNetworkJob = jobs.jobs.some(job =>
                  job.name && job.name.includes(`(${network},`)
                );

                if (hasNetworkJob) {
                  runningWorkflows.push(run);
                }
              } catch (e) {
                console.log(`Error checking jobs for run ${run.id}: ${e.message}`);
              }
            }

            console.log(`Found ${runningWorkflows.length} running/queued workflows for network: ${network}`);
            if (runningWorkflows.length > 0) {
              console.log('Skipping dispatch - workflow already running or queued for this network');
              core.setOutput('should_skip', 'true');
            } else {
              console.log('No running or queued workflows found - proceeding with dispatch');
              core.setOutput('should_skip', 'false');
            }

      - name: Dispatch workflow
        if: steps.check-running.outputs.should_skip == 'false'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: >-
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'syncoor.yaml',
              ref: 'master',
              inputs: {
                'run-timeout': '360',
                'config': `
                  {
                    "network": "${{ env.NETWORK }}",
                    "consensus": {
                      "syncType": "checkpoint",
                      "nodeType": "fullnode",
                      "images": ${{ env.CL_IMAGES }}
                    },
                    "execution": {
                      "images": ${{ env.EL_IMAGES }}
                    }
                  }
                `
              }
            });
